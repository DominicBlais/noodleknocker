<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noodle Knocker - The Learn to Party Game!</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.1/css/bulma.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"
        integrity="sha512-LhccdVNGe2QMEfI3x4DVV3ckMRe36TfydKss6mJpdHjNFiV07dFpS2xzeZedptKZrwxfICJpez09iNioiSZ3hA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }

        .page {
            display: none;
        }

        .page.is-active {
            display: block;
        }

        .footer {
            padding: 1rem 1.5rem 1rem;
        }

        .avatar-image {
            max-width: 200px;
            margin: 0 auto;
        }

        #progress-indicator {
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3273dc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #slide-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            /* Place it behind other elements */
        }

        #slide-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.2;
        }

        /* Add styles for the card to ensure it's above the background */
        #study .card {
            position: relative;
            z-index: 1;
            /* Place it above the background image */
            background-color: rgba(255, 255, 255, 0.925);
            /* Add a semi-transparent background */
        }

        /* Ensure the content is above the background */
        #study .card-content,
        #study .box,
        #study .buttons {
            position: relative;
            z-index: 2;
        }

        .navbar-brand {
            width: 100%;
        }

        .ml-auto {
            margin-left: auto;
        }

        #slide strong {
            color: black;
            font-size: 150%;
        }

        .box strong {
            color: black;
        }

        .message-body {
            font-size:90%;
        }
    </style>
</head>

<body>
    <nav class="navbar has-background-primary-05 is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand is-fullwidth">
            <div class="navbar-item is-size-5 has-text-weight-bold" id="current-page-title" title="Noodle Knocker - The Learn to Party Game!"><img
                    src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&radius=50&backgroundColor=327AFF"
                    style="width:32px;height:32px" /></div>
            <div class="navbar-item has-text-right ml-auto" id="current-page-info">
                <div class="top-buttons is-hidden" id="config-top-buttons">
                    <button class="button is-link is-fullwidth" onclick="startGame()">Start Game</button>
                </div>
                <div class="top-buttons is-hidden" id="study-top-buttons">
                    <div class="buttons is-centered">
                        <button class="button" onclick="prevSlide()" id="previous-slide-button">Previous Slide</button>
                        <button class="button is-info" onclick="nextSlide()" id="next-slide-button">Next Slide</button>
                    </div>
                </div>
                <div class="top-buttons is-hidden" id="q_and_a-top-buttons">
                    <div class="buttons is-centered">
                        <button class="button is-warning" id="question-recording-button"
                            onclick="toggleRecordingQuestion()">Ask Question</button>
                        <button class="button is-link" onclick="showPage('teach')">Ready</button>
                    </div>
                </div>
                <div class="top-buttons is-hidden" id="teach-top-buttons">
                    <div class="buttons is-centered">
                        <button class="button is-warning" id="teach-recording-button"
                            onclick="toggleRecordingTeaching()">Start Talking</button>
                        <button class="button is-info" onclick="prepareNextTeacher()" id="next-player-button">Next
                            Player</button>
                    </div>
                </div>
                <div class="top-buttons is-hidden" id="quiz-top-buttons">
                    <div class="buttons is-centered">
                        <button class="button is-info" onclick="quizButtonPressed()"
                            id="quiz-next-button">Quizzing...</button>
                    </div>
                </div>
                <div class="top-buttons is-hidden" id="results-top-buttons">
                    <div class="buttons is-centered">
                        <button class="button is-link" onclick="resetGame()">Play Again</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <audio id="silent-player" src="/silent.mp3" loop class="is-hidden"></audio>
    <audio id="voice-player" class="is-hidden"></audio>

    <section class="section mt-5">
        <div class="container">
            <!-- Config Page -->
            <div id="config" class="page is-active">
                <article class="message is-info">
                    <div class="message-body">
                        Welcome to <strong>Noodle Knocker</strong>! This fun learning game for up to 4 players challenges
                        you to learn something new and teach it to your AI partner. Your partner then answers Professor
                        Noodle's questions, and the best teacher wins! <strong>Press the "Start Game" button to begin.</strong>
                    </div>
                </article>

                <h1 class="title is-1 has-text-centered">Who's Playing?</h1>
                <div class="columns is-centered">
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">Number of Players</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="player-count" onchange="updatePlayerInputs()">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="player-names" class="mb-6">
                            <!-- Player name inputs will be dynamically added here -->
                        </div>
                        <div class="field mb-6">
                            <label class="label">Difficulty</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="difficulty">
                                        <option value="easy">Easy</option>
                                        <option selected value="normal">Normal</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>

            </div>

            <!-- Study Page -->
            <div id="study" class="page">
                <article class="message is-info">
                    <div class="message-body">
                        Watch Professor's Noodle quick presentation (notes <em>are</em> allowed.) You'll need to teach your AI partner about this
                        topic to win. <strong>After Professor Noodle finishes presenting a slide, press "Next Slide" to continue.</strong>
                    </div>
                </article>

                <h1 class="title is-3 has-text-centered concept-label">Concept Here</h1>

                <div class="columns is-centered">
                    <div class="column is-2">
                        <div class="avatar-professor avatar-talk">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy05&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-professor avatar-normal">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-professor avatar-blink">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&eyes=variant22&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                    </div>
                    <div class="column">
                        <div class="box is-fullwidth has-background-warning-light">
                            <div class="has-text-weight-bold has-text-link-dark">
                                <p id="slide-caption"></p>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="columns is-centered">
                    <div class="column is-two-thirds">
                        <div class="card" data-theme="light">
                            <figure class="image" id="slide-image">
                            </figure>
                            <div class="card-content">
                                <div class="content has-text-black" id="slide">
                                    <h2>Yep</h2>
                                    <p>Hello</p>
                                    <ul>
                                        <li>One</li>
                                        <li>Two</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Q and A Page -->
            <div id="q_and_a" class="page">
                <article class="message is-info">
                    <div class="message-body">
                        Do any players have questions for Professor Noodle? This is your last chance to learn about the
                        topic before teaching your partner. <strong>Press "Ask Question" to ask a question, then that same button again when done recording your question. When you're done asking questions, press "Ready".</strong>
                    </div>
                </article>

                <h1 class="title is-1 has-text-centered">Any Questions?</h1>
                <div class="columns is-centered">
                    <div class="column is-2">
                        <div class="avatar-professor avatar-talk">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy05&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-professor avatar-normal">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-professor avatar-blink">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&eyes=variant22&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                    </div>
                    <div class="column">
                        <div class="box is-fullwidth has-background-warning-light">
                            <div class="has-text-weight-bold has-text-link-dark">
                                <p id="questions-caption">Hello! Do you have any questions?</p>
                            </div>

                        </div>
                    </div>
                </div>


            </div>

            <!-- Teach Page -->
            <div id="teach" class="page">
                <article class="message is-info">
                    <div class="message-body">
                        Time to teach your partner! Share everything you remember about the topic to prepare them for Professor
                        Noodle's questions. <strong>Press "Start Talking" to ask a question, then that same button again when done recording. When you're done asking questions, press "Ready", but be sure that you've taught your partner everything you think they'll need!</strong>
                    </div>
                </article>


                <h1 class="title is-1 has-text-centered" id="teach-title">Player 1's Turn</h1>

                <div class="columns is-centered">
                    <div class="column">
                        <div class="box is-fullwidth has-background-warning-light" id="teach-caption-box">
                            <div class="has-text-weight-bold has-text-link-dark">
                                <p id="teach-caption"></p>
                            </div>
                        </div>
                    </div>
                    <div class="column is-2">
                        <div id="teaching-avatar-talk" class="avatar-player1 avatar-talk">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy05&radius=50&backgroundColor=E0AC69"
                                style="width:128px;height:128px" />
                        </div>
                        <div id="teaching-avatar-normal" class="avatar-player1 avatar-normal">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&radius=50&backgroundColor=E0AC69"
                                style="width:128px;height:128px" />
                        </div>
                        <div id="teaching-avatar-blink" class="avatar-player1 avatar-blink">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&eyes=variant22&radius=50&backgroundColor=E0AC69"
                                style="width:128px;height:128px" />
                        </div>
                    </div>
                </div>


                <div class="columns is-centered">
                    <div class="column">
                        <div class="box">
                            <strong class="has-text-warning">Who is your partner?</strong>
                            <p id="partner-description">Avatar description goes here. This is a paragraph-length
                                description of the avatar.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quiz Page -->
            <div id="quiz" class="page">
                <article class="message is-info">
                    <div class="message-body" id="quiz-help">
                        It's quiz time! Let's see how well your partner has grasped the topic. Good luck!
                    </div>
                </article>

                <h1 class="title is-1 has-text-centered" id="question-count">Question 1 of 5</h1>

                <div class="columns is-centered">
                    <div class="column is-2">
                        <div class="avatar-professor avatar-talk">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy05&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-professor avatar-normal">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-professor avatar-blink">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&eyes=variant22&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                    </div>
                    <div class="column">
                        <div class="box is-fullwidth has-background-warning-light">
                            <div class="has-text-weight-bold has-text-link-dark">
                                <p id="quiz-professor-caption">Quiz question</p>
                            </div>
                        </div>
                    </div>
                </div>
                <hr />


                <div class="columns is-centered">
                    <div class="column">
                        <div class="box is-fullwidth has-background-primary-00" id="quiz-answer-caption-box">
                            <div class="has-text-weight-bold has-text-link-dark">
                                <p id="quiz-answer-caption"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="columns is-centered is-mobile">
                    <div class="column has-text-centered has-background-link" id="player-1-quiz-column">
                        <div class="avatar-player1 avatar-talk" id="quizzing-avatar-player-1-talk">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy05&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-player1 avatar-normal" id="quizzing-avatar-player-1-normal">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-player1 avatar-blink" id="quizzing-avatar-player-1-blink">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&eyes=variant22&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <hr />
                        <p class="has-text-weight-bold is-size-4 is-size-6-mobile has-text-info"
                            id="player-1-quiz-name">Player 1 (Dude)</p>
                        <p class="has-text-weight-bold is-size-2 has-text-warning" id="player-1-quiz-score">0</p>
                    </div>
                    <div class="column has-text-centered has-background-link-dark" id="player-2-quiz-column">
                        <div class="avatar-player2 avatar-talk" id="quizzing-avatar-player-2-talk">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy05&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-player2 avatar-normal" id="quizzing-avatar-player-2-normal">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-player2 avatar-blink" id="quizzing-avatar-player-2-blink">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&eyes=variant22&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <hr />
                        <p class="has-text-weight-bold is-size-4 is-size-6-mobile has-text-info"
                            id="player-2-quiz-name">Player 2 (Dude)</p>
                        <p class="has-text-weight-bold is-size-2 has-text-warning" id="player-2-quiz-score">0</p>
                    </div>
                    <div class="column has-text-centered" id="player-3-quiz-column">
                        <div class="avatar-player3 avatar-talk" id="quizzing-avatar-player-3-talk">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy05&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-player3 avatar-normal" id="quizzing-avatar-player-3-normal">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-player3 avatar-blink" id="quizzing-avatar-player-3-blink">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&eyes=variant22&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <hr />
                        <p class="has-text-weight-bold is-size-4 is-size-6-mobile has-text-info"
                            id="player-3-quiz-name">Player 3 (Dude)</p>
                        <p class="has-text-weight-bold is-size-2 has-text-warning" id="player-3-quiz-score">0</p>
                    </div>
                    <div class="column has-text-centered" id="player-4-quiz-column">
                        <div class="avatar-player4 avatar-talk" id="quizzing-avatar-player-4-talk">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy05&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-player4 avatar-normal" id="quizzing-avatar-player-4-normal">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <div class="avatar-player4 avatar-blink" id="quizzing-avatar-player-4-blink">
                            <img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=Noodle&mouth=happy02&eyes=variant22&backgroundColor=E0AC69&radius=50"
                                style="width:128px;height:128px" />
                        </div>
                        <hr />
                        <p class="has-text-weight-bold is-size-4 is-size-6-mobile has-text-info"
                            id="player-4-quiz-name">Player 4 (Dude)</p>
                        <p class="has-text-weight-bold is-size-2 has-text-warning" id="player-4-quiz-score">0</p>
                    </div>
                </div>
            </div>

            <!-- Results Page -->
            <div id="results" class="page">
                <article class="message is-info">
                    <div class="message-body">
                        Wow, check out your score! Ready to play again?
                    </div>
                </article>

                <h1 class="title is-1 has-text-centered">Scoreboard</h1>
                <div class="columns is-centered">
                    <div class="column is-two-thirds">
                        <hr/>
                        <div class="fixed-grid">
                            <div class="grid has-2-cols" id="scoreboard">
                                
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>


        </div>
    </section>

    <div id="waiting-to-start-game-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head is-centered">
                <p class="modal-card-title is-3 has-text-warning concept-label has-text-centered is-centered"
                    id="concept-generating-label">Choosing Topic...</p>
            </header>
            <section class="modal-card-body has-text-centered">
                <div class="box" id="concept-trivia" data-theme="light"></div>
                <div id="progress-indicator"></div>
                <p class="has-text-centered is-size-6">Please wait while your game is being created...</p>
            </section>
        </div>
    </div>

    <footer class="footer mt-auto">
        <div class="content has-text-centered is-size-7">
            <p>Copyright &copy; 2024 by Dominic Sellers-Blais. Licensed under the <a
                    href="https://github.com/DominicBlais/noodleknocker/blob/master/LICENSE.txt" target="_blank">MIT License</a>. <a
                    href="https://github.com/DominicBlais/noodleknocker" class="has-text-warning"
                    target="_blank">GitHub repo.</a></p>
        </div>
    </footer>

    <script>
        const Commands = {
            GENERATE: 'generate',
            GENERATE_STARTED: 'generate-started',
            GENERATE_DONE: 'generate-done',
            TTS: 'tts',
            SAY: 'say',
            STOP_GENERATING_SPEECH: 'stop-generating-speech',
            DONE_SPEAKING: 'done-speaking',
            START_TRANSCRIBING: 'start-transcribing',
            STOP_TRANSCRIBING: 'stop-transcribing',
            TRANSCRIBED: 'transcribed',
            TRANSCRIBE_DONE: 'transcribe-done',
            ASK_QUESTION: 'ask-question',
            ASK_QUESTION_ANSWER_PART: 'ask-question-answer-part',
            ASK_QUESTION_FINISHED: 'ask-question-finished',
            TEACH_CONTESTANT: 'teach-contestant',
            TEACH_CONTESTANT_ANSWER_PART: 'teach-contestant-answer-part',
            TEACH_CONTESTANT_FINISHED: 'teach-contestant-finished',
            CONTESTANT_QUIZ: 'contestant-quiz',
            CONTESTANT_QUIZ_ANSWER_PART: 'contestant-quiz-answer-part',
            CONTESTANT_QUIZ_FINISHED: 'contestant-quiz-finished',
            PROFESSOR_QUIZ: 'professor-quiz',
            PROFESSOR_QUIZ_ANSWER_PART: 'professor-quiz-answer-part',
            PROFESSOR_QUIZ_FINISHED: 'professor-quiz-finished',
        }

        const Difficulties = {
            EASY: 'easy',
            NORMAL: 'normal',
            HARD: 'hard',
        }

        const States = {
            PLAYER_SETUP: 'player-setup',
            WAITING_FOR_GENERATION: 'waiting-for-generation',
            STUDYING: 'studying',
            Q_AND_A: 'q-and-a',
            TEACHING: 'teaching',
            QUIZZING: 'quizzing',
            RESULTS: 'results',
        }

        const Speakers = {
            NOBODY: 'nobody',
            PROFESSOR: 'professor',
            PLAYER1: 'player1',
            PLAYER2: 'player2',
            PLAYER3: 'player3',
            PLAYER4: 'player4'
        }


        const playerNames = [
            'Player 1',
            'Player 2',
            'Player 3',
            'Player 4'
        ];

        let playerCount = 1;
        let difficulty = 'normal';
        let concept = 'none';
        let presentation = null;
        let playerData = [];
        let currentSlideIndex = 0;
        let currentSlide;
        let currentSlideSentences = [];

        let voiceClips = [];
        let isDoneWithVoice = false;
        let speakingInterval = null;

        let mediaStream = null;
        let audioContent = null;
        let audioSource = null;
        let audioProcessor = null;
        let transcription = '';

        let playersNeedingToTeach = [];
        let currentPlayerIndex = 0;

        let questionsNeedingAsking = [];
        let playersNeedingToAnswer = [];
        let currentQuestionIndex = 0;

        let responseText = '';

        let ws;

        let state = States.PLAYER_SETUP;

        let waitingMusic;

        let whoIsTalking = Speakers.NOBODY;


        function getCookie(name, defaultValue = '') {
            const cname = name + '=';
            const decodedCookie = decodeURIComponent(document.cookie);
            const ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(cname) == 0) {
                    return c.substring(cname.length, c.length);
                }
            }
            return defaultValue;
        }

        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = 'expires=' + d.toUTCString();
            document.cookie = name + '=' + value + ';' + expires + ';path=/;SameSite=Lax';
        }

        function tts(text, speaker) {
            whoIsTalking = speaker;
            sendCmd(Commands.TTS, {
                text: text,
                speaker: speaker
            });
        }


        function sendCmd(cmd, data) {
            ws.send(JSON.stringify({
                'cmd': cmd,
                ...data
            }))
        }

        async function showPage(pageId) {
            // all top-buttons class should be hidden
            document.querySelectorAll('.top-buttons').forEach(buttons => buttons.classList.add('is-hidden'));
            document.getElementById(pageId + '-top-buttons').classList.remove('is-hidden');
            if (pageId === 'config') {
                await gotoConfigPage();
            } else if (pageId === 'study') {
                await gotoStudyPage();
            } else if (pageId === 'q_and_a') {
                await gotoQandAPage();
            } else if (pageId === 'teach') {
                await gotoTeachPage();
            } else if (pageId === 'quiz') {
                await gotoQuizPage();
            } else if (pageId === 'results') {
                await gotoResultsPage();
            }
        }

        function animateSpeakers() {
            function setAnimationFrame(target) {
                document.querySelectorAll('.avatar-' + target).forEach(avatar => {
                    avatar.classList.add('is-hidden');
                });
                const roll = Math.random();
                if (roll < 0.025) {
                    document.querySelectorAll('.avatar-' + target + '.avatar-blink').forEach(avatar => {
                        avatar.classList.remove('is-hidden');
                    });
                } else if (whoIsTalking === target && roll < 0.6) {
                    document.querySelectorAll('.avatar-' + target + '.avatar-talk').forEach(avatar => {
                        avatar.classList.remove('is-hidden');
                    });
                } else {
                    document.querySelectorAll('.avatar-' + target + '.avatar-normal').forEach(avatar => {
                        avatar.classList.remove('is-hidden');
                    });
                }
            }
            [Speakers.PROFESSOR, Speakers.PLAYER1, Speakers.PLAYER2, Speakers.PLAYER3, Speakers.PLAYER4].forEach(setAnimationFrame);
        }

        function updatePlayerInputs() {
            playerCount = parseInt(document.getElementById('player-count').value);
            setCookie('playerCount', document.getElementById('player-count').value, 365);

            const playerNamesDiv = document.getElementById('player-names');

            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById(`player-${i}-name`);
                if (input) {
                    playerNames[i - 1] = input.value;
                    setCookie('player' + i, input.value, 365);
                }
            }

            playerNamesDiv.innerHTML = '';
            for (let i = 1; i <= playerCount; i++) {
                const playerField = document.createElement('div');
                playerField.className = 'field player-name-field';
                playerField.innerHTML = `
                    <label class="label ml-4">Player ${i} Name</label>
                    <div class="control ml-4">
                        <input class="input" type="text" placeholder="Enter player name" id="player-${i}-name" value="${playerNames[i - 1]}">
                    </div>
                `;
                playerNamesDiv.appendChild(playerField);
            }
        }

        function prepareNextTeacher() {
            stopSpeaking();
            state = States.TEACHING;
            currentPlayerIndex = playersNeedingToTeach[0];
            const nextPlayerButton = document.getElementById('next-player-button');
            if (playersNeedingToTeach.length === 0) {
                showPage('quiz');
                return;
            } else if (playersNeedingToTeach.length === 1) {
                nextPlayerButton.classList.remove('is-info');
                nextPlayerButton.classList.add('is-link');
                nextPlayerButton.innerText = 'Ready';
            } else {
                nextPlayerButton.classList.remove('is-link');
                nextPlayerButton.classList.add('is-info');
                nextPlayerButton.innerText = 'Next Teacher';
            }
            if (playerNames[playersNeedingToTeach[0]].endsWith('s') || playerNames[playersNeedingToTeach[0]].endsWith('S')) {
                document.getElementById('teach-title').innerText = playerNames[playersNeedingToTeach[0]] + "' Turn";
            } else {
                document.getElementById('teach-title').innerText = playerNames[playersNeedingToTeach[0]] + "'s Turn";
            }
            let contestantInfo = playerData[playersNeedingToTeach[0]];
            contestantInfo.hexColor = Array.from({ length: 3 }, () => Math.floor(Math.random() * (256 - 120) + 120).toString(16).padStart(2, '0')).join('');
            const talkContainer = document.getElementById('teaching-avatar-talk');
            const normalContainer = document.getElementById('teaching-avatar-normal');
            const blinkContainer = document.getElementById('teaching-avatar-blink');
            talkContainer.classList.remove('avatar-player1', 'avatar-player2', 'avatar-player3', 'avatar-player4');
            normalContainer.classList.remove('avatar-player1', 'avatar-player2', 'avatar-player3', 'avatar-player4');
            blinkContainer.classList.remove('avatar-player1', 'avatar-player2', 'avatar-player3', 'avatar-player4');
            const avatarId = ['avatar-player1', 'avatar-player2', 'avatar-player3', 'avatar-player4'][playersNeedingToTeach[0]];
            talkContainer.classList.add(avatarId);
            normalContainer.classList.add(avatarId);
            blinkContainer.classList.add(avatarId);
            talkContainer.innerHTML = `<img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=${contestantInfo.name}&flip=true&mouth=happy05&radius=50&backgroundColor=${contestantInfo.hexColor}" style="width:128px;height:128px" />`;
            if (contestantInfo.gender === 'female') {
                normalContainer.innerHTML = `<img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=${contestantInfo.name}&flip=true&mouth=happy03&radius=50&backgroundColor=${contestantInfo.hexColor}" style="width:128px;height:128px" />`;
                blinkContainer.innerHTML = `<img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=${contestantInfo.name}&flip=true&mouth=happy03&eyes=variant22&radius=50&backgroundColor=${contestantInfo.hexColor}" style="width:128px;height:128px" />`;
            } else {
                normalContainer.innerHTML = `<img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=${contestantInfo.name}&flip=true&mouth=happy01&radius=50&backgroundColor=${contestantInfo.hexColor}" style="width:128px;height:128px" />`;
                blinkContainer.innerHTML = `<img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=${contestantInfo.name}&flip=true&mouth=happy01&eyes=variant01&radius=50&backgroundColor=${contestantInfo.hexColor}" style="width:128px;height:128px" />`;
            }
            document.getElementById('partner-description').innerText = contestantInfo.description
                .replace(/You are/gi, 'I am')
                .replace(/yourself/g, 'myself')
                .replace(/your/g, 'my')
                .replace(/Yourself/g, 'Myself')
                .replace(/Your/g, 'My')
                .replace(/you/gi, 'I');
            document.getElementById('teach-caption-box').style.setProperty('background-color', `#${contestantInfo.hexColor}`, 'important');
            const teachButton = document.getElementById('teach-recording-button');
            teachButton.innerText = 'Thinking...';
            teachButton.classList.remove('is-danger');
            teachButton.classList.add('is-info');
            isDoneWithVoice = false;
            speakingInterval = setInterval(continueSpeaking, 50);
            responseText = '';
            sendCmd(Commands.TEACH_CONTESTANT, {
                playerIndex: playersNeedingToTeach[0],
                text: `Hi. My name is ${playerNames[playersNeedingToTeach[0]]}. Please briefly introduce yourself and ask me to teach you about ${concept}.`,
            });
            playersNeedingToTeach.shift();
        }

        function quizButtonPressed() {
            const nextQuizButton = document.getElementById('quiz-next-button');
            if (nextQuizButton.innerText === 'Quizzing...') {
                // TBD: allow them to stop speaking early
                // stopSpeaking();
            } else {
                prepareNextQuestion();
            }
        }

        function prepareNextQuestion() {
            stopSpeaking();
            state = States.QUIZZING;
            if (questionsNeedingAsking.length === 0) {
                showPage('results');
                return;
            }
            const nextQuizButton = document.getElementById('quiz-next-button');
            nextQuizButton.innerText = 'Quizzing...';
            nextQuizButton.classList.remove('is-link');
            nextQuizButton.classList.add('is-info');

            document.getElementById('quiz-answer-caption').innerText = '';
            document.getElementById('quiz-answer-caption-box').style.removeProperty('background-color');

            for (let i = 0; i < playerCount; i++) {
                document.getElementById('player-' + (i + 1) + '-quiz-score').innerText = playerData[i].score;
                document.getElementById('player-' + (i + 1) + '-quiz-name').innerText = playerData[i].name + '\n(' + playerNames[i] + ')';
                document.getElementById('player-' + (i + 1) + '-quiz-column').classList.remove('has-background-link', 'has-background-link-dark', 'is-hidden');
                let contestantInfo = playerData[i];
                contestantInfo.hexColor = Array.from({ length: 3 }, () => Math.floor(Math.random() * (256 - 120) + 120).toString(16).padStart(2, '0')).join('');
                const talkContainer = document.getElementById('quizzing-avatar-player-' + (i + 1) + '-talk');
                const normalContainer = document.getElementById('quizzing-avatar-player-' + (i + 1) + '-normal');
                const blinkContainer = document.getElementById('quizzing-avatar-player-' + (i + 1) + '-blink');
                talkContainer.innerHTML = `<img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=${contestantInfo.name}&flip=true&mouth=happy05&radius=50&backgroundColor=${contestantInfo.hexColor}" style="width:128px;height:128px" />`;
                if (contestantInfo.gender === 'female') {
                    normalContainer.innerHTML = `<img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=${contestantInfo.name}&flip=true&mouth=happy03&radius=50&backgroundColor=${contestantInfo.hexColor}" style="width:128px;height:128px" />`;
                    blinkContainer.innerHTML = `<img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=${contestantInfo.name}&flip=true&mouth=happy03&eyes=variant22&radius=50&backgroundColor=${contestantInfo.hexColor}" style="width:128px;height:128px" />`;
                } else {
                    normalContainer.innerHTML = `<img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=${contestantInfo.name}&flip=true&mouth=happy01&radius=50&backgroundColor=${contestantInfo.hexColor}" style="width:128px;height:128px" />`;
                    blinkContainer.innerHTML = `<img src="https://api.dicebear.com/9.x/lorelei-neutral/svg?seed=${contestantInfo.name}&flip=true&mouth=happy01&eyes=variant01&radius=50&backgroundColor=${contestantInfo.hexColor}" style="width:128px;height:128px" />`;
                }
            }
            for (let i = 4; i > playerCount; i--) {
                document.getElementById('player-' + i + '-quiz-column').classList.add('is-hidden');
            }

            let text = 'Next question: ';

            currentQuestionIndex = 5 - questionsNeedingAsking.length;
            document.getElementById('question-count').innerText = 'Question ' + (currentQuestionIndex + 1) + ' of 5';

            if (questionsNeedingAsking.length === 5) {
                text = 'Welcome to Noodle Knocker! First question: ' + presentation.questions[0];
            } else if (questionsNeedingAsking.length === 4) {
                text = 'Second question: ' + presentation.questions[1];
            } else if (questionsNeedingAsking.length === 3) {
                text = 'Third question: ' + presentation.questions[2];
            } else if (questionsNeedingAsking.length === 2) {
                text = 'Fourth question: ' + presentation.questions[3];
            } else if (questionsNeedingAsking.length === 1) {
                text = 'Last question: ' + presentation.questions[4];
            }
            let justQuestion = presentation.questions[5 - questionsNeedingAsking.length];
            justQuestion = justQuestion[0].toLowerCase() + justQuestion.slice(1);
            document.getElementById('quiz-help').innerHTML = 'The question is <strong>&quot;' + justQuestion + '&quot;</strong>';

            const converter = new showdown.Converter();
            document.getElementById('quiz-professor-caption').innerHTML = converter.makeHtml(text);
            tts(text, Speakers.PROFESSOR);

            playersNeedingToAnswer = [0, 1, 2, 3].slice(0, playerCount).sort(() => Math.random() - 0.5);

            questionsNeedingAsking.shift();

        }

        function prepareNextAnswer() {
            if (playersNeedingToAnswer.length === 0) {
                const nextQuizButton = document.getElementById('quiz-next-button');
                nextQuizButton.classList.remove('is-info');
                nextQuizButton.classList.add('is-link');
                if (questionsNeedingAsking.length === 0) {
                    nextQuizButton.innerText = 'Ready';
                } else {
                    nextQuizButton.innerText = 'Next Question';
                }
                return;
            }
            currentPlayerIndex = playersNeedingToAnswer.shift();
            const contestantInfo = playerData[currentPlayerIndex];
            document.getElementById('player-' + (currentPlayerIndex + 1) + '-quiz-column').classList.add('has-background-link');
            document.getElementById('quiz-answer-caption-box').style.setProperty('background-color', `#${contestantInfo.hexColor}`, 'important');
            //document.getElementById('quiz-professor-caption').innerText = '';
            isDoneWithVoice = false;
            speakingInterval = setInterval(continueSpeaking, 50);
            responseText = '';
            sendCmd(Commands.CONTESTANT_QUIZ, {
                playerIndex: currentPlayerIndex,
                questionIndex: currentQuestionIndex
            });
        }

        function processGrade(playerIndex, grade) {
            const contestantInfo = playerData[playerIndex];
            const oldScore = playerData[playerIndex].score;
            const additionalScore = grade * (currentQuestionIndex + 1) * 10;
            playerData[playerIndex].score = oldScore + additionalScore;
            document.getElementById('player-' + (playerIndex + 1) + '-quiz-score').innerHTML = oldScore + '<br/><span class="has-text-success">+' + additionalScore + '</span>';
        }

        function toggleRecordingTeaching() {
            try {
                const teachButton = document.getElementById('teach-recording-button');
                if (teachButton.innerText === 'Start Talking') {
                    stopSpeaking();
                    teachButton.innerText = ' Start Talking ';
                    startTranscribing();
                    setTimeout(() => {
                        teachButton.innerText = 'Recording (Press to Finish)';
                        teachButton.classList.remove('is-warning');
                        teachButton.classList.add('is-danger');
                    }, 500);
                } else if (teachButton.innerText === 'Recording (Press to Finish)') {
                    teachButton.innerText = 'Thinking...';
                    teachButton.classList.remove('is-danger');
                    teachButton.classList.add('is-info');
                    stopTranscribing();
                    isDoneWithVoice = false;
                    speakingInterval = setInterval(continueSpeaking, 50);
                }
            } catch (err) {
                console.error(err);
            }

        }


        async function gotoConfigPage() {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('is-active'));
            document.getElementById('config').classList.add('is-active');
            state = States.PLAYER_SETUP;
        }

        async function gotoStudyPage() {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('is-active'));
            document.getElementById('study').classList.add('is-active');
            state = States.STUDYING;
        }

        async function gotoQandAPage() {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('is-active'));
            document.getElementById('q_and_a').classList.add('is-active');
            document.getElementById('questions-caption').innerText = 'Hello! Do you have any questions?';
            tts('Hello! Do you have any questions?', Speakers.PROFESSOR);
            state = States.Q_AND_A;
        }

        async function gotoTeachPage() {
            if (document.getElementById('question-recording-button').innerText !== 'Ask Question') {
                stopSpeaking();
            }
            document.querySelectorAll('.page').forEach(page => page.classList.remove('is-active'));
            document.getElementById('teach').classList.add('is-active');
            playersNeedingToTeach = [0, 1, 2, 3].slice(0, playerCount).sort(() => Math.random() - 0.5);
            prepareNextTeacher();
        }

        async function gotoQuizPage() {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('is-active'));
            document.getElementById('quiz').classList.add('is-active');
            document.getElementById('quiz-help').innerText = 'It\'s quiz time! Let\'s see how well your partner has grasped the topic. Good luck!';
            questionsNeedingAsking = presentation.questions.slice();
            prepareNextQuestion();
        }

        async function gotoResultsPage() {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('is-active'));
            document.getElementById('results').classList.add('is-active');
            const defaults = {
                spread: 360,
                ticks: 50,
                origin: { y: 0.25 },
                decay: 0.94,
                startVelocity: 30,
                colors: ['FFE400', 'FFBD00', 'E89400', 'FFCA6C', 'FDFFB8']
            };
            for (let i = 0; i < playerCount; i++) {
                playerData[i].playerName = playerNames[i];
            }

            let sortedPlayerData = playerData.slice();
            sortedPlayerData.sort((a, b) => b.score - a.score);
            let scoreboardHtml = `<div class="cell has-text-right m-1 mb-4"><h1 class="title is-2 has-text-info">${sortedPlayerData[0].playerName}</h1></div><div class="cell m-1 mb-4"><h1 class="title is-2 has-text-warning">${sortedPlayerData[0].score}</h1></div>`;
            for (let i = 1; i < sortedPlayerData.length; i++) {
                scoreboardHtml += `<div class="cell has-text-right m-1"><h1 class="subtitle is-3 has-text-info">${sortedPlayerData[i].playerName}</h1></div><div class="cell m-1"><h1 class="subtitle is-3 has-text-warning">${sortedPlayerData[i].score}</h1></div>`;
            }
            document.getElementById('scoreboard').innerHTML = scoreboardHtml;

            const fanfareMusic = new Audio('/fanfare.mp3');
            fanfareMusic.addEventListener('loadeddata', function() {
                fanfareMusic.play();
                function shoot() {
                    confetti({
                        ...defaults,
                        particleCount: 40,
                        scalar: 1.2,
                        shapes: ['star']
                    });
    
                    confetti({
                        ...defaults,
                        particleCount: 10,
                        scalar: 0.75,
                        shapes: ['circle']
                    });
                }
    
                setTimeout(shoot, 500);
                setTimeout(shoot, 600);
                setTimeout(shoot, 700);
            });
            fanfareMusic.load();
    
        }

        async function startGame() {
            // silent.mp3 is played to avoid popping and audio loss on some audio systems when audio is frequently started and stopped
            document.getElementById('silent-player').play();
            updatePlayerInputs();
            difficulty = document.getElementById('difficulty').value;
            document.getElementById('concept-trivia').innerText = 'Generating...';
            document.getElementById('waiting-to-start-game-modal').classList.add('is-active');
            state = States.WAITING_FOR_GENERATION;
            sendCmd(Commands.GENERATE, {
                'playerNames': playerNames,
                'playerCount': playerCount,
                'difficulty': difficulty
            });
            waitingMusic = new Audio('/waiting-loop.mp3');
            waitingMusic.loop = true;
            waitingMusic.play();
        }

        function resetGame() {
            location.reload();
        }


        function convertFloat32ToInt16(float32Array) {
            let int16Array = new Int16Array(float32Array.length);
            for (let i = 0; i < float32Array.length; i++) {
                int16Array[i] = Math.max(-1, Math.min(1, float32Array[i])) * 0x7FFF;
            }
            return int16Array;
        }

        async function startTranscribing() {
            transcription = '';
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioSource = audioContext.createMediaStreamSource(mediaStream);
            audioProcessor = audioContext.createScriptProcessor(2048, 1, 1)
            sendCmd(Commands.START_TRANSCRIBING, {
                'sampleRate': audioContext.sampleRate
            });
            audioProcessor.onaudioprocess = function (evt) {
                let inputData = evt.inputBuffer.getChannelData(0);
                let rawAudioData = convertFloat32ToInt16(new Float32Array(inputData));
                ws.send(rawAudioData);
            }
            audioSource.connect(audioProcessor);
            audioProcessor.connect(audioContext.destination);
        }

        async function stopTranscribing() {
            if (audioContext) {
                audioProcessor.disconnect();
                audioSource.disconnect();
                await audioContext.close();
                audioContext = null;

                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                sendCmd(Commands.STOP_TRANSCRIBING);
            }
        }

        async function toggleRecordingQuestion() {
            try {
                const questionsButton = document.getElementById('question-recording-button');
                if (questionsButton.innerText === 'Ask Question') {
                    stopSpeaking();
                    questionsButton.innerText = ' Ask Question ';
                    startTranscribing();
                    setTimeout(() => {
                        questionsButton.innerText = 'Recording (Press to Finish)';
                        questionsButton.classList.remove('is-warning');
                        questionsButton.classList.add('is-danger');
                    }, 500);
                } else if (questionsButton.innerText === 'Recording (Press to Finish)') {
                    questionsButton.innerText = 'Thinking...';
                    questionsButton.classList.remove('is-danger');
                    questionsButton.classList.add('is-info');
                    stopTranscribing();
                    isDoneWithVoice = false;
                    speakingInterval = setInterval(continueSpeaking, 50);
                }
            } catch (err) {
                console.error(err);
            }
        }

        function splitIntoCaptions(text) {
            const MIN_SENTENCE_LENGTH = 50;
            const MIN_CAPTION_LENGTH = 100;

            const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
            let captions = [];
            let currentCaption = "";

            for (let i = 0; i < sentences.length; i++) {
                const sentence = sentences[i].trim();
                const nextSentence = (i + 1 < sentences.length) ? sentences[i + 1].trim() : "";

                if (sentence.length < MIN_SENTENCE_LENGTH && nextSentence.length < MIN_SENTENCE_LENGTH) {
                    currentCaption += sentence + " ";
                } else {
                    currentCaption += sentence + " ";
                    if (currentCaption.length >= MIN_CAPTION_LENGTH || i === sentences.length - 1) {
                        captions.push(currentCaption.trim());
                        currentCaption = "";
                    }
                }
            }

            if (currentCaption.length > 0) {
                captions.push(currentCaption.trim());
            }

            return captions;
        }

        function showSlide(slideIndex) {
            currentSlideIndex = slideIndex;
            currentSlide = presentation.slides[currentSlideIndex];
            const converter = new showdown.Converter();
            const slideHtml = converter.makeHtml(currentSlide.textContent.replace(//g, '-'));
            const slideElement = document.getElementById('slide');
            slideElement.innerHTML = `<div>${slideHtml}</div>`;
            let nextSlideButton = document.getElementById('next-slide-button');
            nextSlideButton.classList.remove('is-link');
            nextSlideButton.classList.add('is-info');
            if (currentSlideIndex === presentation.slides.length - 1) {
                nextSlideButton.innerText = 'Ready';
            } else {
                nextSlideButton.innerText = 'Next Slide';
            }
            stopSpeaking();
            currentSlideSentences = splitIntoCaptions(currentSlide.narration);
            speakingInterval = setInterval(continueSpeaking, 50);
        }



        function prevSlide() {
            if (currentSlideIndex > 0) {
                currentSlideIndex--;
                showSlide(currentSlideIndex);
            }
        }

        function nextSlide() {
            if (currentSlideIndex < presentation.slides.length - 1) {
                currentSlideIndex++;
                showSlide(currentSlideIndex);
            } else {
                stopSpeaking();
                showPage('q_and_a');
            }
        }

        function continueSpeaking() {
            const voicePlayer = document.getElementById('voice-player');
            if (voicePlayer.paused) {
                if (voiceClips.length > 0) {
                    const data = voiceClips.shift();
                    if (!data) {
                        return;
                    }
                    const url = URL.createObjectURL(data);
                    voicePlayer.src = url;
                    voicePlayer.load();
                    voicePlayer.onloadeddata = function () {
                        voicePlayer.play();
                    }
                } else if (isDoneWithVoice) {
                    const wasProfessor = whoIsTalking === Speakers.PROFESSOR;
                    whoIsTalking = Speakers.NOBODY;
                    if (speakingInterval !== null) {
                        clearInterval(speakingInterval);
                        speakingInterval = null;
                    }
                    if (currentSlideSentences.length > 0) {
                        const caption = currentSlideSentences.shift();
                        const captionElem = document.getElementById('slide-caption');
                        captionElem.innerText = caption;
                        tts(caption, Speakers.PROFESSOR);
                    } else if (state === States.STUDYING) {
                        const nextSlideButton = document.getElementById('next-slide-button');
                        nextSlideButton.classList.remove('is-info');
                        nextSlideButton.classList.add('is-link');
                    } else if (state === States.QUIZZING) {
                        if (wasProfessor) {
                            prepareNextAnswer();
                        } else {
                            const columnElem = document.getElementById('player-' + (currentPlayerIndex + 1) + '-quiz-column');
                            columnElem.classList.remove('has-background-link');
                            columnElem.classList.add('has-background-link-dark');
                            isDoneWithVoice = false;
                            speakingInterval = setInterval(continueSpeaking, 50);
                            responseText = '';
                            sendCmd(Commands.PROFESSOR_QUIZ, {
                                playerIndex: currentPlayerIndex,
                                questionIndex: currentQuestionIndex
                            });
                        }
                    }
                }
            }
        }

        function stopSpeaking() {
            whoIsTalking = Speakers.NOBODY;
            if (speakingInterval !== null) {
                clearInterval(speakingInterval);
                speakingInterval = null;
            }
            currentSlideSentences = [];
            voiceClips = [];
            sendCmd(Commands.STOP_GENERATING_SPEECH, {});
            const voicePlayer = document.getElementById('voice-player');
            voicePlayer.pause();
            isDoneWithVoice = true;
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.location.protocol === 'https:') {
                ws = new WebSocket('wss://' + window.location.host + '/ws');
            } else {
                ws = new WebSocket('ws://' + window.location.host + '/ws');
            }

            ws.onopen = function (event) {
            };

            ws.onmessage = function (event) {
                if (typeof event.data === 'string') {
                    const jsonData = JSON.parse(event.data);
                    const cmd = jsonData['cmd'];
                    if (cmd === Commands.GENERATE_STARTED) {
                        concept = jsonData['concept'];
                        document.querySelectorAll('.concept-label').forEach(element => {
                            element.innerText = concept;
                        });
                        const triviaItems = jsonData['trivia'];
                        let triviaIndex = 0;
                        function setNextTrivia() {
                            if (state === States.WAITING_FOR_GENERATION) {
                                triviaIndex = (triviaIndex + 1) % triviaItems.length;
                                document.getElementById('concept-trivia').innerText = triviaItems[triviaIndex];
                                setTimeout(setNextTrivia, 10000);
                            }
                        }
                        setNextTrivia();
                    } else if (cmd === Commands.GENERATE_DONE) {
                        waitingMusic.pause();
                        waitingMusic = null;
                        presentation = jsonData.presentation;
                        playerData = jsonData.playerData;
                        document.getElementById('waiting-to-start-game-modal').classList.remove('is-active');

                        showPage('study');
                        showSlide(0);
                        document.getElementById('slide-image').innerHTML = `<img src="${jsonData.base64Image}"/>`;

                        state = States.STUDYING;
                    } else if (cmd === Commands.DONE_SPEAKING) {
                        isDoneWithVoice = true;
                    } else if (cmd === Commands.TRANSCRIBED) {
                        transcription += jsonData.text + ' ';
                    } else if (cmd === Commands.TRANSCRIBE_DONE) {
                        if (state === States.Q_AND_A) {
                            if (transcription.trim().length > 0) {
                                responseText = '';
                                document.getElementById('questions-caption').innerHTML = '';
                                sendCmd(Commands.ASK_QUESTION, {
                                    text: transcription
                                })
                            } else {
                                const questionsButton = document.getElementById('question-recording-button');
                                questionsButton.innerText = 'Ask Question';
                                questionsButton.classList.remove('is-info');
                                questionsButton.classList.add('is-warning');
                            }
                        } else if (state === States.TEACHING) {
                            if (transcription.trim().length > 0) {
                                responseText = '';
                                document.getElementById('teach-caption').innerHTML = '';
                                sendCmd(Commands.TEACH_CONTESTANT, {
                                    playerIndex: currentPlayerIndex,
                                    text: transcription
                                })
                            } else {
                                const teachButton = document.getElementById('teach-recording-button');
                                teachButton.innerText = 'Start Talking';
                                teachButton.classList.remove('is-info');
                                teachButton.classList.add('is-warning');
                            }
                        }
                    } else if (cmd === Commands.ASK_QUESTION_ANSWER_PART) {
                        const questionsButton = document.getElementById('question-recording-button');
                        whoIsTalking = Speakers.PROFESSOR;
                        questionsButton.innerText = 'Answering...';
                        responseText += jsonData.text + ' ';
                        const converter = new showdown.Converter();
                        document.getElementById('questions-caption').innerHTML = converter.makeHtml(responseText);
                    } else if (cmd === Commands.ASK_QUESTION_FINISHED) {
                        const questionsButton = document.getElementById('question-recording-button');
                        questionsButton.innerText = 'Ask Question';
                        questionsButton.classList.remove('is-info');
                        questionsButton.classList.add('is-warning');
                    } else if (cmd === Commands.TEACH_CONTESTANT_ANSWER_PART) {
                        const teachButton = document.getElementById('teach-recording-button');
                        whoIsTalking = jsonData.speaker;
                        teachButton.innerText = 'Answering...';
                        responseText += jsonData.text + ' ';
                        const converter = new showdown.Converter();
                        document.getElementById('teach-caption').innerHTML = converter.makeHtml(responseText);
                    } else if (cmd === Commands.TEACH_CONTESTANT_FINISHED) {
                        const teachButton = document.getElementById('teach-recording-button');
                        teachButton.innerText = 'Start Talking';
                        teachButton.classList.remove('is-info');
                        teachButton.classList.add('is-warning');
                    } else if (cmd === Commands.CONTESTANT_QUIZ_ANSWER_PART) {
                        whoIsTalking = jsonData.speaker;
                        responseText += jsonData.text + ' ';
                        const converter = new showdown.Converter();
                        document.getElementById('quiz-answer-caption').innerHTML = converter.makeHtml(responseText);
                    } else if (cmd === Commands.CONTESTANT_QUIZ_FINISHED) {
                        // TBD: this might be safe to prune
                    } else if (cmd === Commands.PROFESSOR_QUIZ_ANSWER_PART) {
                        whoIsTalking = Speakers.PROFESSOR;
                        responseText += jsonData.text + ' ';
                        const converter = new showdown.Converter();
                        document.getElementById('quiz-professor-caption').innerHTML = converter.makeHtml(responseText);
                    } else if (cmd === Commands.PROFESSOR_QUIZ_FINISHED) {
                        processGrade(jsonData.playerIndex, jsonData.grade);
                    }
                } else {
                    voiceClips.push(event.data);
                    isDoneWithVoice = false;
                    if (speakingInterval === null) {
                        speakingInterval = setInterval(continueSpeaking, 50);
                    }
                }
            };

            ws.onclose = function (event) {
                console.log('Websocket closed!');
                alert('The connection was lost. Please reload the page.');
                location.reload();
            };

            document.getElementById('player-count').value = getCookie('playerCount', '1');
            updatePlayerInputs();
            for (let i = 1; i <= 4; i++) {
                const elem = document.getElementById(`player-${i}-name`);
                if (elem) {
                    elem.value = getCookie('player' + i, 'Player ' + i);
                    playerNames[i - 1] = elem.value;
                }
            }

            setInterval(animateSpeakers, 70);

            var userAgent = navigator.userAgent.toLowerCase();
            if (userAgent.includes('safari') && !userAgent.includes('chrome')) {
                // Safari has super-strict audio playback restrictions that prevent background handling on the incoming voice audio data.
                alert('Sorry, but Safari is not currently supported. Please use a different browser like Chrome, Firefox, or Edge.')
            }

            showPage('config');

        });

    </script>
</body>

</html>
